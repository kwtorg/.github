# .github/.github/workflows/reusable-ci-cd.yml

name: Reusable Docker CI/CD

on:
  workflow_call:

jobs:
  # --- ì¡ 1: ë‹¨ìˆœ ì½”ë“œ ì—…ë°ì´íŠ¸ (No-Deploy Push) ---
  # Self-Hosted Runnerì—ì„œëŠ” ì†ŒìŠ¤ ì½”ë“œë¥¼ checkoutí•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ì„œë²„ì— ìµœì‹  ì½”ë“œê°€ ë°˜ì˜ë˜ë¯€ë¡œ,
  # ì´ ì¡ì€ ì‚¬ì‹¤ìƒ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì‘ì—…ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
  update-code-only:
    if: "!contains(github.event.head_commit.message, '[deploy]')"
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log code update
        run: |
          echo "âœ… Repository code updated on the self-hosted runner."
          echo "ğŸ”„ Code synchronization complete."

  # --- ì¡ 2: ë¹Œë“œ, ì „ì†¡, ë°°í¬ (Deploy Push) ---
  build-and-deploy:
    if: "contains(github.event.head_commit.message, '[deploy]')"
    runs-on: self-hosted
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # Runnerê°€ ì„¤ì¹˜ëœ ì„œë²„ì˜ ì‘ì—… ë””ë ‰í„°ë¦¬ë¡œ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Docker ë¹Œë“œ ë° ë°°í¬
      # SSH/SCPê°€ í•„ìš” ì—†ì´ Runnerì—ì„œ ì§ì ‘ Docker ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Build and Deploy on Server
        working-directory: ${{ github.workspace }}
        run: |
          # ê° ì €ì¥ì†Œì˜ ì»¨í…Œì´ë„ˆê°€ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ í”„ë¡œì íŠ¸ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          REPO_NAME=${{ github.event.repository.name }}
          echo "ğŸš€ Starting deployment for $REPO_NAME..."

          # .env íŒŒì¼ì´ ì—†ìœ¼ë©´ .env.exampleì„ ë³µì‚¬í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
          if [ ! -f .env ]; then
            echo "ğŸ“‹ .env file not found. Copying from .env.example..."
            cp .env.example .env
          fi

          # ë¡œê·¸ ë””ë ‰í„°ë¦¬ ìƒì„±
          mkdir -p logs

          # Docker Composeë¡œ ë¹Œë“œ ë° ì‹¤í–‰
          # --project-name ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ê° ë¦¬í¬ì§€í† ë¦¬ì˜ ì»¨í…Œì´ë„ˆë¥¼ ê²©ë¦¬í•©ë‹ˆë‹¤.
          echo "ğŸ³ Building and running Docker containers..."
          docker compose --project-name $REPO_NAME build
          docker compose --project-name $REPO_NAME up -d

          # ë¶ˆí•„ìš”í•œ ë¹Œë” ìºì‹œ ì •ë¦¬
          echo "ğŸ§¹ Pruning Docker builder cache..."
          docker builder prune -f

          echo "ğŸ‰ Deployment completed successfully for $REPO_NAME!"
