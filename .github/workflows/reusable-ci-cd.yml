# íŒŒì¼ ê²½ë¡œ: .github/.github/workflows/reusable-ci-cd.yml
# ì—­í• : .env ìë™ ìƒì„± ê¸°ëŠ¥ì´ í¬í•¨ëœ ìµœì¢… CI/CD ì›Œí¬í”Œë¡œìš°

name: Reusable Per-Architecture Deployment

on:
  workflow_call:
    # â„¹ï¸ í˜¸ì¶œí•˜ëŠ” ì›Œí¬í”Œë¡œìš°ë¡œë¶€í„° secretsë¥¼ ì „ë‹¬ë°›ê¸° ìœ„í•´ ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸í•©ë‹ˆë‹¤.
    secrets:
      DOT_ENV:
        required: false # ì´ secretì´ ì—†ì–´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ì‹¤íŒ¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

jobs:
  sync-and-deploy:
    strategy:
      matrix:
        architecture: [arm64, amd64]
    runs-on:
      - self-hosted
      - ${{ matrix.architecture }}

    steps:
      # 1. ë² ì´ìŠ¤ ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: Create base repositories directory
        shell: bash
        run: |
          mkdir -p ~/repositories
          echo "âœ… Base directory ~/repositories is ready."

      # 2. ì§€ì •ëœ ê²½ë¡œë¡œ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository to specific path
        uses: actions/checkout@v4
        with:
          path: '~/repositories/${{ github.event.repository.name }}'
      
      # âœ¨ [ìˆ˜ì •] 3. GitHub Secretìœ¼ë¡œ .env íŒŒì¼ ìë™ ìƒì„±
      - name: Create .env file if required
        id: create-dotenv
        working-directory: '~/repositories/${{ github.event.repository.name }}'
        shell: bash
        run: |
          # docker-compose.yml ì— env_file ì˜µì…˜ì´ ìˆëŠ”ì§€ ì²´í¬
          if grep -q "env_file:" docker-compose.yml; then
            echo "â„¹ï¸ docker-compose.yml requires an .env file."
            
            # secret ì´ ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ .env íŒŒì¼ ìƒì„±
            if [ -n "${{ secrets.DOT_ENV }}" ]; then
              echo "ğŸ”‘ DOT_ENV secret found. Creating .env file..."
              echo "${{ secrets.DOT_ENV }}" > .env
              echo "âœ… .env file created successfully."
            else
              echo "âŒ DOT_ENV secret is missing, but docker-compose.yml requires .env"
              exit 1
            fi
          else
            echo "â„¹ï¸ docker-compose.yml does not reference an .env file. Skipping."
          fi

      # 4. Docker ë³¼ë¥¨ì„ ìœ„í•œ ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: Create directories for Docker volumes
        working-directory: '~/repositories/${{ github.event.repository.name }}'
        shell: bash
        run: |
          if [ -f .volume_dirs ]; then
            echo "ğŸ“„ .volume_dirs file found. Creating specified directories..."
            grep -v '^#' .volume_dirs | grep -v '^[[:space:]]*$' | xargs mkdir -p
            echo "âœ… All directories for volumes are created."
          else
            echo "â„¹ï¸ .volume_dirs file not found, skipping directory creation."
          fi

      # 5. ì¡°ê±´ë¶€ ë¹Œë“œ ë° ë°°í¬
      - name: Build and Deploy (if [deploy] is in commit message)
        if: "contains(github.event.head_commit.message, '[deploy]')"
        working-directory: '~/repositories/${{ github.event.repository.name }}'
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ğŸš€ Commit includes [deploy], starting build and deploy process for $REPO_NAME on ${{ matrix.architecture }}..."
          docker compose --project-name $REPO_NAME build
          docker compose --project-name $REPO_NAME up -d --remove-orphans
          docker builder prune -f
          echo "ğŸ‰ ${{ matrix.architecture }} deployment completed successfully for $REPO_NAME!"

      # 6. [deploy]ê°€ ì—†ì„ ê²½ìš° ì•Œë¦¼ ë©”ì‹œì§€ ì¶œë ¥
      - name: Notify code sync only
        if: "!contains(github.event.head_commit.message, '[deploy]')"
        run: |
          echo "âœ… Code sync completed for ${{ github.event.repository.name }} on ${{ matrix.architecture }}. No [deploy] keyword found, skipping build and deployment."
