# íŒŒì¼: .github/.github/workflows/reusable-ci-cd.yml

name: Reusable Per-Architecture Deployment

on:
  workflow_call:

jobs:
  # --- ì¡ 1: ARM64 ì„œë²„ì— ë°°í¬ ---
  deploy-arm64:
    # â„¹ï¸ ìˆ˜ì • ë¶ˆí•„ìš”: [deploy] ì»¤ë°‹ì¼ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: "contains(github.event.head_commit.message, '[deploy]')"
    # â„¹ï¸ ìˆ˜ì • ë¶ˆí•„ìš”: 'arm64' ë ˆì´ë¸”ì´ ë‹¬ë¦° Runnerì—ì„œë§Œ ì´ ì¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    runs-on:
      - self-hosted
      - arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and Deploy on ARM64 Server
        working-directory: ${{ github.workspace }}
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ğŸš€ Starting ARM64 deployment for $REPO_NAME..."
          # ARM64 Runnerê°€ ARM64 ì„œë²„ì—ì„œ ì§ì ‘ ë„¤ì´í‹°ë¸Œ ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          docker compose --project-name $REPO_NAME build
          docker compose --project-name $REPO_NAME up -d
          docker builder prune -f
          echo "ğŸ‰ ARM64 deployment completed successfully for $REPO_NAME!"

  # --- ì¡ 2: AMD64(Intel) ì„œë²„ì— ë°°í¬ ---
  deploy-amd64:
    # â„¹ï¸ ìˆ˜ì • ë¶ˆí•„ìš”: [deploy] ì»¤ë°‹ì¼ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: "contains(github.event.head_commit.message, '[deploy]')"
    # â„¹ï¸ ìˆ˜ì • ë¶ˆí•„ìš”: 'amd64' ë ˆì´ë¸”ì´ ë‹¬ë¦° Runnerì—ì„œë§Œ ì´ ì¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    runs-on:
      - self-hosted
      - amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and Deploy on AMD64 Server
        working-directory: ${{ github.workspace }}
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ğŸš€ Starting AMD64 deployment for $REPO_NAME..."
          # AMD64 Runnerê°€ Intel ì„œë²„ì—ì„œ ì§ì ‘ ë„¤ì´í‹°ë¸Œ ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          docker compose --project-name $REPO_NAME build
          docker compose --project-name $REPO_NAME up -d
          docker builder prune -f
          echo "ğŸ‰ AMD64 deployment completed successfully for $REPO_NAME!"
