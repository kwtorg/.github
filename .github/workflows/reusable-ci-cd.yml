# íŒŒì¼ ìœ„ì¹˜ : .github/.github/workflows/reusable-ci-cd.yml
name: Reusable Per-Architecture Deployment

on:
  workflow_call:
    secrets:
      DOT_ENV:
        required: true   # .env ë°˜ë“œì‹œ í•„ìš” (HOST_PORT í¬í•¨)

jobs:
  sync-and-deploy:
    if: ${{ github.repository != 'kwtorg/project-template' }}
    strategy:
      matrix:
        architecture: [arm64, amd64]
    runs-on:
      - self-hosted
      - ${{ matrix.architecture }}

    steps:
      # 1. ë² ì´ìŠ¤ ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: Create base repositories directory
        shell: bash
        run: mkdir -p /home/ubuntu/repositories

      # 2. Checkout
      - name: Checkout source
        uses: actions/checkout@v4

      # 3. ì†ŒìŠ¤ ë™ê¸°í™”
      - name: Sync repository to /home/ubuntu/repositories
        shell: bash
        run: |
          mkdir -p /home/ubuntu/repositories/${{ github.event.repository.name }}
          rsync -av --delete $GITHUB_WORKSPACE/ /home/ubuntu/repositories/${{ github.event.repository.name }}/

      # 4. .env íŒŒì¼ ìƒì„± (DOT_ENV -> .env)
      - name: Create .env file from DOT_ENV secret
        working-directory: /home/ubuntu/repositories/${{ github.event.repository.name }}
        shell: bash
        env:
          DOT_ENV: ${{ secrets.DOT_ENV }}
        run: |
          echo "$DOT_ENV" > .env
          if ! grep -q "HOST_PORT=" .env; then
            echo "âŒ HOST_PORT not set in DOT_ENV secret!"
            exit 1
          fi
          echo "âœ… .env file created with HOST_PORT"

      # 5. Docker ë³¼ë¥¨ ë””ë ‰í† ë¦¬ ìƒì„±
      - name: Create directories for Docker volumes
        working-directory: /home/ubuntu/repositories/${{ github.event.repository.name }}
        shell: bash
        run: |
          if [ -f .volume_dirs ]; then
            grep -v '^#' .volume_dirs | grep -v '^[[:space:]]*$' | xargs mkdir -p
            echo "âœ… Volume directories created"
          else
            echo "â„¹ï¸ .volume_dirs not found, skipping"
          fi

      # 5.5. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
      - name: Stop and remove existing containers
        if: contains(github.event.head_commit.message, '[deploy]')
        working-directory: /home/ubuntu/repositories/${{ github.event.repository.name }}
        shell: bash
        run: |
          echo "ğŸ›‘ Stopping and removing existing containers..."
          docker compose --project-name ${{ github.event.repository.name }} down --remove-orphans || true

      # 6. Build & Deploy
      - name: Build and Deploy (if [deploy] is in commit message)
        if: contains(github.event.head_commit.message, '[deploy]')
        working-directory: /home/ubuntu/repositories/${{ github.event.repository.name }}
        shell: bash
        run: |
          export REPO_NAME=${{ github.event.repository.name }}
          export HOST_REPO_PATH=/home/ubuntu/repositories/${{ github.event.repository.name }}
          export COMMIT_SHA=${{ github.sha }}

          echo "ğŸš€ Building $REPO_NAME ($COMMIT_SHA, tagging also as latest)..."
          docker build -t $REPO_NAME:$COMMIT_SHA -t $REPO_NAME:latest .

          docker compose --project-name $REPO_NAME up -d --remove-orphans

          docker builder prune -f
          echo "ğŸ‰ Deployment completed for $REPO_NAME!"

      # 7. deploy keyword ì—†ìœ¼ë©´ syncë§Œ
      - name: Notify code sync only
        if: "!contains(github.event.head_commit.message, '[deploy]')"
        run: echo "âœ… Code synced (no deploy)"

      # 8. ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
      - name: Cleanup old docker images
        shell: bash
        run: |
          docker image prune -af --filter "until=72h"
