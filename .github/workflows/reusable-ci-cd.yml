# ===================================================================
# [Template] Reusable Self-Hosted CI/CD Workflow (vars 버전)
# -------------------------------------------------------------------
# vars.DEPLOY_RUNNER (nas/mini)를 참조하여 해당 서버에서
# 빌드 및 배포를 수행합니다.
# ===================================================================
name: Reusable Self-Hosted CI/CD Workflow

on:
  workflow_call:
    secrets:
      DOT_ENV_PROD:
        required: true

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ vars.DEPLOY_RUNNER }}"]
    env:
      REPO_NAME: ${{ github.event.repository.name }}
      REPO_DIR: /home/runner/repositories/${{ github.event.repository.name }}
      COMMIT_MSG: ${{ github.event.head_commit.message }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Ensure target directory exists
        run: mkdir -p $REPO_DIR        
        
      - name: Sync code into target repo dir
        run: rsync -av --delete $GITHUB_WORKSPACE/ $REPO_DIR/
        
      - name: Create .env from Secrets
        env:
          DOT_ENV_PROD: ${{ secrets.DOT_ENV_PROD }}
        run: |
          cat <<EOF > $REPO_DIR/.env
          $DOT_ENV_PROD
          EOF

      - name: Check for [deploy] keyword
        id: deploy_check
        run: |
          if [[ "${{ env.COMMIT_MSG }}" == *"[deploy]"* ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop, Build, and Deploy
        if: steps.deploy_check.outputs.deploy == 'true'
        working-directory: ${{ env.REPO_DIR }}
        run: docker compose -f docker-compose.yml --project-name $REPO_NAME up -d --build --remove-orphans

      - name: Cleanup old docker images
        if: steps.deploy_check.outputs.deploy == 'true'
        run: docker image prune -af --filter "until=72h"
