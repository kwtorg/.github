# íŒŒì¼ ê²½ë¡œ: .github/.github/workflows/reusable-ci-cd.yml
# ì—­í• : ì‹¤ì œ ì½”ë“œ ë™ê¸°í™”, ë¹Œë“œ, ë°°í¬ ë¡œì§ì„ ì •ì˜í•˜ëŠ” ì¬ì‚¬ìš© ì›Œí¬í”Œë¡œìš°

name: Reusable Per-Architecture Deployment

on:
  workflow_call:

jobs:
  # --- ARM64 ë° AMD64 ì„œë²„ì— ë™ê¸°í™” ë° ë°°í¬ (Matrix ì „ëµìœ¼ë¡œ í†µí•©) ---
  sync-and-deploy:
    # â„¹ï¸ Matrix ì „ëµì„ ì‚¬ìš©í•´ ARM64ì™€ AMD64 ì¡ì„ í•˜ë‚˜ë¡œ í†µí•©í•˜ì—¬ ì½”ë“œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì…ë‹ˆë‹¤.
    strategy:
      matrix:
        architecture: [arm64, amd64]

    # â„¹ï¸ 'self-hosted' ë° matrixì— ì •ì˜ëœ ì•„í‚¤í…ì²˜ ë ˆì´ë¸”ì„ ê°€ì§„ Runnerì—ì„œ ì¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    runs-on:
      - self-hosted
      - ${{ matrix.architecture }}

    steps:
      # [í•´ê²°] ìœ ì˜ì‚¬í•­2: ì½”ë“œ ì €ì¥ ê²½ë¡œ ì§€ì • ë° í´ë” ìƒì„±
      # 1. í”„ë¡œì íŠ¸ ì½”ë“œë¥¼ ì €ì¥í•  ë¶€ëª¨ ë””ë ‰í„°ë¦¬ ìƒì„± (~/repositories)
      - name: Create base repositories directory
        # ì…¸ì˜ í™ˆ ë””ë ‰í„°ë¦¬(~)ë¥¼ ì°¸ì¡°í•˜ê¸° ìœ„í•´ bashë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        shell: bash
        run: |
          # ~/repositories ë””ë ‰í„°ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±í•©ë‹ˆë‹¤.
          mkdir -p ~/repositories
          echo "âœ… Base directory ~/repositories is ready."

      # 2. ì§€ì •ëœ ê²½ë¡œë¡œ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (ë˜ëŠ” ìµœì‹ í™”)
      - name: Checkout repository to specific path
        uses: actions/checkout@v4
        with:
          # ê° í”„ë¡œì íŠ¸ ì €ì¥ì†Œ ì´ë¦„ìœ¼ë¡œ ëœ í´ë” ë‚´ì— ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
          # ì´ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ git pullê³¼ ë™ì¼í•˜ê²Œ ìµœì‹  ì½”ë“œë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
          path: '~/repositories/${{ github.event.repository.name }}'

      # [í•´ê²°] ìœ ì˜ì‚¬í•­3: Docker ë³¼ë¥¨ì„ ìœ„í•œ ë””ë ‰í„°ë¦¬ ìë™ ìƒì„±
      # 3. .volume_dirs íŒŒì¼ì— ëª…ì‹œëœ ë””ë ‰í„°ë¦¬ ìƒì„±
      - name: Create directories for Docker volumes
        # ì²´í¬ì•„ì›ƒëœ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•˜ì—¬ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        working-directory: '~/repositories/${{ github.event.repository.name }}'
        shell: bash
        run: |
          # .volume_dirs íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          if [ -f .volume_dirs ]; then
            echo "ğŸ“„ .volume_dirs file found. Creating specified directories..."
            # íŒŒì¼ì˜ ê° ì¤„ì„ ì½ì–´ ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. -p ì˜µì…˜ìœ¼ë¡œ í•˜ìœ„ ë””ë ‰í„°ë¦¬ê¹Œì§€ ì•ˆì „í•˜ê²Œ ìƒì„±í•©ë‹ˆë‹¤.
            # ë¹ˆ ì¤„ì´ë‚˜ ì£¼ì„(#ìœ¼ë¡œ ì‹œì‘)ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.
            grep -v '^#' .volume_dirs | grep -v '^[[:space:]]*$' | xargs mkdir -p
            echo "âœ… All directories for volumes are created."
          else
            echo "â„¹ï¸ .volume_dirs file not found, skipping directory creation."
          fi

      # [í•´ê²°] ìœ ì˜ì‚¬í•­1: ì»¤ë°‹ ë©”ì‹œì§€ì— ë”°ë¼ ë¹Œë“œ ë° ë°°í¬ë¥¼ ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰
      # 4. ì¡°ê±´ë¶€ ë¹Œë“œ ë° ë°°í¬
      - name: Build and Deploy (if [deploy] is in commit message)
        # ì»¤ë°‹ ë©”ì‹œì§€ì— '[deploy]'ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: "contains(github.event.head_commit.message, '[deploy]')"
        working-directory: '~/repositories/${{ github.event.repository.name }}'
        run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "ğŸš€ Commit includes [deploy], starting build and deploy process for $REPO_NAME on ${{ matrix.architecture }}..."
          # docker-compose.ymlì´ ìˆëŠ” í”„ë¡œì íŠ¸ í´ë” ë‚´ë¶€ì—ì„œ ì§ì ‘ ë„¤ì´í‹°ë¸Œ ë¹Œë“œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          docker compose --project-name $REPO_NAME build
          docker compose --project-name $REPO_NAME up -d --remove-orphans
          docker builder prune -f
          echo "ğŸ‰ ${{ matrix.architecture }} deployment completed successfully for $REPO_NAME!"

      # 5. [deploy]ê°€ ì—†ì„ ê²½ìš° ì•Œë¦¼ ë©”ì‹œì§€ ì¶œë ¥
      - name: Notify code sync only
        # ì»¤ë°‹ ë©”ì‹œì§€ì— '[deploy]'ê°€ í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: "!contains(github.event.head_commit.message, '[deploy]')"
        run: |
          echo "âœ… Code sync completed for ${{ github.event.repository.name }} on ${{ matrix.architecture }}. No [deploy] keyword found, skipping build and deployment."
